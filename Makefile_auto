# ìë™ ìµœì í™” Makefile
# í•˜ë“œì›¨ì–´ì— ë§ëŠ” ìµœì  ì„¤ì •ì„ ìë™ìœ¼ë¡œ ì°¾ì•„ ì‹¤í–‰

# ê¸°ë³¸ ì„¤ì •
IN ?= data/20140413.mp4
OUT ?= output/auto_optimized_result.mp4
STYLE ?= mosaic
SAFETY_MARGIN ?= 12

# Docker ì´ë¯¸ì§€ ì´ë¦„
IMAGE_NAME = video-anonymizer-auto:latest

# ë„ì›€ë§
.PHONY: help
help:
	@echo "ğŸš€ ìë™ ìµœì í™” ë¹„ë””ì˜¤ ìµëª…í™” Makefile"
	@echo ""
	@echo "ì£¼ìš” ëª…ë ¹ì–´:"
	@echo "  make auto-run         - ìë™ ìµœì í™” ì‹¤í–‰ (í•˜ë“œì›¨ì–´ ë§ì¶¤ ì„¤ì •)"
	@echo "  make hardware-info    - í•˜ë“œì›¨ì–´ ì •ë³´ í™•ì¸"
	@echo "  make auto-docker      - Dockerë¡œ ìë™ ìµœì í™” ì‹¤í–‰"
	@echo "  make benchmark        - ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰"
	@echo ""
	@echo "ì„¤ì • ì˜µì…˜:"
	@echo "  IN=íŒŒì¼ëª…            - ì…ë ¥ ë¹„ë””ì˜¤ (ê¸°ë³¸: $(IN))"
	@echo "  OUT=íŒŒì¼ëª…           - ì¶œë ¥ ë¹„ë””ì˜¤ (ê¸°ë³¸: $(OUT))"
	@echo "  STYLE=ìŠ¤íƒ€ì¼         - ìµëª…í™” ìŠ¤íƒ€ì¼ (ê¸°ë³¸: $(STYLE))"
	@echo "  SAFETY_MARGIN=ìˆ«ì   - ì•ˆì „ ì—¬ë°± (ê¸°ë³¸: $(SAFETY_MARGIN))"
	@echo ""
	@echo "ê³ ê¸‰ ì˜µì…˜:"
	@echo "  OVERRIDE='key=value' - ì„¤ì • ì˜¤ë²„ë¼ì´ë“œ"
	@echo "  FORCE_CPU=1         - CPUë§Œ ì‚¬ìš©"
	@echo ""
	@echo "ì˜ˆì‹œ:"
	@echo "  make auto-run IN=my_video.mp4 OUT=result.mp4"
	@echo "  make auto-run OVERRIDE='batch_size=16 confidence=0.25'"
	@echo "  make auto-run FORCE_CPU=1"

# ì˜ì¡´ì„± ì„¤ì¹˜
.PHONY: install-auto
install-auto:
	@echo "ğŸ“¦ ìë™ ìµœì í™” ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
	pip install -r requirements_auto.txt
	@echo "âœ… ì„¤ì¹˜ ì™„ë£Œ"

# í•˜ë“œì›¨ì–´ ì •ë³´ í™•ì¸
.PHONY: hardware-info
hardware-info:
	@echo "ğŸ” í•˜ë“œì›¨ì–´ ì •ë³´ ê°ì§€ ì¤‘..."
	python -m anonymizer.cli_auto --hardware-info

# ìë™ ìµœì í™” ì‹¤í–‰ (ë¡œì»¬)
.PHONY: auto-run
auto-run:
	@echo "ğŸš€ ìë™ ìµœì í™” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘..."
	@echo "ì…ë ¥: $(IN) â†’ ì¶œë ¥: $(OUT)"
	@mkdir -p $(dir $(OUT))
ifdef OVERRIDE
	python -m anonymizer.cli_auto \
		--input "$(IN)" \
		--output "$(OUT)" \
		--style "$(STYLE)" \
		--safety-margin $(SAFETY_MARGIN) \
		$(foreach override,$(shell echo "$(OVERRIDE)" | tr ' ' '\n'),--override $(override)) \
		$(if $(FORCE_CPU),--force-cpu) \
		--verbose
else
	python -m anonymizer.cli_auto \
		--input "$(IN)" \
		--output "$(OUT)" \
		--style "$(STYLE)" \
		--safety-margin $(SAFETY_MARGIN) \
		$(if $(FORCE_CPU),--force-cpu) \
		--verbose
endif
	@echo "âœ… ì²˜ë¦¬ ì™„ë£Œ: $(OUT)"

# ë¹ ë¥¸ ì‹¤í–‰ (ê¸°ë³¸ ì„¤ì •)
.PHONY: quick-auto
quick-auto:
	@echo "âš¡ ë¹ ë¥¸ ìë™ ìµœì í™” ì‹¤í–‰"
	python -m anonymizer.cli_auto --input "$(IN)" --output "$(OUT)"

# Docker ì´ë¯¸ì§€ ë¹Œë“œ (ìë™ ìµœì í™” í¬í•¨)
.PHONY: build-auto
build-auto:
	@echo "ğŸ—ï¸ ìë™ ìµœì í™” Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
	docker build -f Dockerfile.auto -t $(IMAGE_NAME) .
	@echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: $(IMAGE_NAME)"

# Dockerë¡œ ìë™ ìµœì í™” ì‹¤í–‰
.PHONY: auto-docker
auto-docker:
	@echo "ğŸ³ Docker ìë™ ìµœì í™” ì‹¤í–‰ ì¤‘..."
	@mkdir -p $(dir $(OUT))
	docker run --rm --gpus all \
		-v "$(PWD)":/workspace \
		-w /workspace \
		$(IMAGE_NAME) \
		python -m anonymizer.cli_auto \
		--input "$(IN)" \
		--output "$(OUT)" \
		--style "$(STYLE)" \
		--safety-margin $(SAFETY_MARGIN) \
		$(if $(OVERRIDE),$(foreach override,$(shell echo "$(OVERRIDE)" | tr ' ' '\n'),--override $(override))) \
		$(if $(FORCE_CPU),--force-cpu) \
		--verbose
	@echo "âœ… Docker ì²˜ë¦¬ ì™„ë£Œ: $(OUT)"

# ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬
.PHONY: benchmark
benchmark:
	@echo "ğŸƒâ€â™‚ï¸ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰ ì¤‘..."
	python -m anonymizer.cli_auto --benchmark --input "$(IN)"

# ì„¤ì • ìºì‹œ ì‚­ì œ
.PHONY: clear-cache
clear-cache:
	@echo "ğŸ—‘ï¸ ì„¤ì • ìºì‹œ ì‚­ì œ ì¤‘..."
	rm -f auto_config_cache.json
	@echo "âœ… ìºì‹œ ì‚­ì œ ì™„ë£Œ"

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
.PHONY: test-auto
test-auto:
	@echo "ğŸ§ª ìë™ ìµœì í™” í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	python -c "from anonymizer.auto_optimizer import HardwareProfiler, AutoConfig; print('âœ… ìë™ ìµœì í™” ëª¨ë“ˆ í…ŒìŠ¤íŠ¸ ì„±ê³µ')"

# ìƒì„¸ í•˜ë“œì›¨ì–´ ë¶„ì„
.PHONY: analyze-hardware
analyze-hardware:
	@echo "ğŸ”¬ ìƒì„¸ í•˜ë“œì›¨ì–´ ë¶„ì„ ì¤‘..."
	python -c "
from anonymizer.auto_optimizer import HardwareProfiler, AutoConfig
import torch

hw = HardwareProfiler.detect_hardware()
print(f'CPU ì„±ëŠ¥: {hw.cpu_cores}ì½”ì–´ / {hw.cpu_threads}ìŠ¤ë ˆë“œ')
print(f'ë©”ëª¨ë¦¬: {hw.total_ram_gb:.1f}GB ì´ / {hw.available_ram_gb:.1f}GB ì‚¬ìš©ê°€ëŠ¥')

if hw.gpu_available:
    print(f'GPU: {hw.gpu_name}')
    print(f'GPU ë©”ëª¨ë¦¬: {hw.gpu_memory_gb:.1f}GB')
    print(f'CUDA ì§€ì›: {torch.cuda.is_available()}')
    if torch.cuda.is_available():
        print(f'CUDA ë²„ì „: {torch.version.cuda}')
        print(f'GPU ê°œìˆ˜: {torch.cuda.device_count()}')
else:
    print('GPU: ê°ì§€ë˜ì§€ ì•ŠìŒ')

auto_config = AutoConfig()
settings = auto_config.generate_optimal_config()
"

# ëª¨ë“  íŒŒì´í”„ë¼ì¸ ë¹„êµ í…ŒìŠ¤íŠ¸
.PHONY: compare-all
compare-all:
	@echo "ğŸ“Š ëª¨ë“  íŒŒì´í”„ë¼ì¸ ì„±ëŠ¥ ë¹„êµ ì¤‘..."
	@echo "1. ê¸°ë³¸ íŒŒì´í”„ë¼ì¸"
	@time make run IN="$(IN)" OUT="output/basic_result.mp4" 2>&1 | grep "FPS\|ì‹œê°„"
	@echo ""
	@echo "2. Ultra ìµœì í™” íŒŒì´í”„ë¼ì¸"
	@time make run-ultra IN="$(IN)" OUT="output/ultra_result.mp4" 2>&1 | grep "FPS\|ì‹œê°„"
	@echo ""
	@echo "3. Speed ìµœì í™” íŒŒì´í”„ë¼ì¸"  
	@time make run-speed IN="$(IN)" OUT="output/speed_result.mp4" 2>&1 | grep "FPS\|ì‹œê°„"
	@echo ""
	@echo "4. ìë™ ìµœì í™” íŒŒì´í”„ë¼ì¸"
	@time make auto-run IN="$(IN)" OUT="output/auto_result.mp4" 2>&1 | grep "FPS\|ì‹œê°„"
	@echo ""
	@echo "ğŸ“ ëª¨ë“  ê²°ê³¼ íŒŒì¼ì´ output/ ë””ë ‰í† ë¦¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤"

# ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ê³¼ í•¨ê»˜ ì‹¤í–‰
.PHONY: auto-run-monitor
auto-run-monitor:
	@echo "ğŸ“Š ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ê³¼ í•¨ê»˜ ìë™ ìµœì í™” ì‹¤í–‰"
	bash -c "
	(while true; do 
		echo -n '$(shell date +%T) - '; 
		nvidia-smi --query-gpu=utilization.gpu,utilization.memory,memory.used,memory.total --format=csv,noheader,nounits 2>/dev/null || echo 'GPU ì •ë³´ ì—†ìŒ'; 
		sleep 2; 
	done) &
	MONITOR_PID=\$$!;
	trap 'kill \$$MONITOR_PID 2>/dev/null' EXIT;
	$(MAKE) auto-run IN='$(IN)' OUT='$(OUT)' $(if $(OVERRIDE),OVERRIDE='$(OVERRIDE)') $(if $(FORCE_CPU),FORCE_CPU=1)
	"

# ì •ë¦¬
.PHONY: clean-auto
clean-auto:
	@echo "ğŸ§¹ ìë™ ìµœì í™” ê´€ë ¨ íŒŒì¼ ì •ë¦¬ ì¤‘..."
	rm -f auto_config_cache.json
	rm -f output/auto_*.mp4
	@echo "âœ… ì •ë¦¬ ì™„ë£Œ"