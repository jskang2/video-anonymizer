#  ğŸš€ GPU Docker ë¹Œë“œ ëª…ë ¹ì–´
#
#  ê¸°ë³¸ ë¹Œë“œ ëª…ë ¹ì–´
#
#  # Makefileì„ í†µí•œ ë¹Œë“œ (ê¶Œì¥)
#  make build
#
#  # ì§ì ‘ Docker ëª…ë ¹ì–´ (** ì´ê²ƒìœ¼ë¡œ ë¹Œë“œ í•˜ê¸° - compose ëŠ” gpuê°€ ì˜ ì•ˆëœë‹¤ê³  í•´ì„œ ì‚¬ìš©ì•ˆí•¨ **) 
#  docker build -f Dockerfile.gpu -t video-anonymizer-gpu:slim .
#
#  ë¹Œë“œëœ ì´ë¯¸ì§€ í™•ì¸
#
#  # ì´ë¯¸ì§€ ëª©ë¡ í™•ì¸
#  docker images | grep video-anonymizer
#
#  # í˜„ì¬ ë¹Œë“œëœ ì´ë¯¸ì§€ ì •ë³´
#  # video-anonymizer-gpu     slim        [IMAGE_ID]   [ì‹œê°„]   13GB
#
#  í…ŒìŠ¤íŠ¸ ëª…ë ¹ì–´
#
#  # í•˜ë“œì›¨ì–´ ì •ë³´ í™•ì¸
#  make hardware-info
#
#  # OpenCV í…ŒìŠ¤íŠ¸
#  docker run --gpus all --rm video-anonymizer-gpu:slim python -c "import cv2; print('OpenCV version:', cv2.__version__)"
#
#  # CLI ë„ì›€ë§ í™•ì¸
#  docker run --gpus all --rm video-anonymizer-gpu:slim python -m anonymizer.cli_ultra_auto --help
#
#  ì‹¤í–‰ ëª…ë ¹ì–´ (ë¹Œë“œ í›„)
#
#  # ìë™ ìµœì í™” ì‹¤í–‰ (ê¶Œì¥)
#  make run-auto-speed IN=input.mp4
#
#  # ìˆ˜ë™ ì‹¤í–‰
#  docker run --gpus all --rm \
#    -v $(PWD):/workspace \
#    video-anonymizer-gpu:slim \
#    python -m anonymizer.cli_ultra_auto \
#    --input video.mp4 --output result.mp4 --auto
#
#  í˜„ì¬ ë¹Œë“œ ìƒíƒœ
#
#  - âœ… ì´ë¯¸ì§€: video-anonymizer-gpu:slim (13GB)
#  - âœ… ê¸°ë°˜: PyTorch 2.0.1 + CUDA 11.7 + cuDNN 8
#  - âœ… í…ŒìŠ¤íŠ¸: ëª¨ë“  ê¸°ëŠ¥ ì •ìƒ ì‘ë™ í™•ì¸
#  - âœ… í•˜ë“œì›¨ì–´: RTX 3060 Ti (8GB) ìë™ ê°ì§€

##==============================================================================================================

#  ê¸°ë³¸ ì˜ìƒ ì²˜ë¦¬ ëª…ë ¹ì–´ë“¤
#
#  # 1. ìë™ ìµœì í™” ì‹¤í–‰ (ê¶Œì¥)
#  make run-auto-speed IN=data/input.mp4
#
#  # 2. ê³ í’ˆì§ˆ íŒŒì´í”„ë¼ì¸
#  make run-auto-ultra IN=data/input.mp4
#
#  # 3. ìˆ˜ë™ Docker ì‹¤í–‰
#  docker run --gpus all --rm \
#    -v "/mnt/d/MYCLAUDE_PROJECT/YOLO-ì˜ìƒë‚´íŠ¹ì •ê°ì²´-ëª¨ìì´í¬-ë¸”ëŸ¬ì²˜ë¦¬-ìë™í™”":/workspace \
#    -w /workspace \
#    video-anonymizer-gpu:slim \
#    python -m anonymizer.cli_ultra_auto \
#    --input data/input.mp4 \
#    --output output/result.mp4 \
#    --auto --max-performance
#
#  # 4. ê¸°ë³¸ CLI ì‚¬ìš©
#  docker run --gpus all --rm \
#    -v "/mnt/d/MYCLAUDE_PROJECT/YOLO-ì˜ìƒë‚´íŠ¹ì •ê°ì²´-ëª¨ìì´í¬-ë¸”ëŸ¬ì²˜ë¦¬-ìë™í™”":/workspace \
#    -w /workspace \
#    video-anonymizer-gpu:slim \
#    python -m anonymizer.cli \
#    --input data/input.mp4 \
#    --output output/result_basic.mp4 \
#    --parts eyes,elbows \
#    --style mosaic \
#    --gpu-optimized


##==============================================================================================================


# GPU ì§€ì› ìë™ ìµœì í™” Docker ì´ë¯¸ì§€
FROM pytorch/pytorch:2.0.1-cuda11.7-cudnn8-runtime

# í™˜ê²½ë³€ìˆ˜ ì„¤ì • (ë¹„ëŒ€í™”í˜• ì„¤ì¹˜)
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Seoul

# ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    tzdata \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    libgtk-3-0 \
    libavcodec-dev \
    libavformat-dev \
    libswscale-dev \
    libv4l-dev \
    libxvidcore-dev \
    libx264-dev \
    libatlas-base-dev \
    libgl1-mesa-glx \
    gfortran \
    wget \
    git \
    && rm -rf /var/lib/apt/lists/*

# OpenCV ì„¤ì¹˜ (GPU ì§€ì›)
RUN pip install opencv-python-headless

# Python ì˜ì¡´ì„± ì„¤ì¹˜ (GPU ì§€ì›)
COPY requirements-gpu.txt /tmp/
RUN pip install --no-cache-dir -r /tmp/requirements-gpu.txt

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /workspace

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY anonymizer/ /workspace/anonymizer/
COPY configs/ /workspace/configs/

# Python íŒ¨ìŠ¤ ì„¤ì •
ENV PYTHONPATH="/workspace:$PYTHONPATH"

# CUDA í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility

# output ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /workspace/output

# ê¸°ë³¸ ëª…ë ¹ì–´
CMD ["python", "-m", "anonymizer.cli_auto", "--help"]